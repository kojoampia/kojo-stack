{"ast":null,"code":"import { ReplaySubject, of } from 'rxjs';\nimport { shareReplay, tap, catchError } from 'rxjs/operators';\nimport { SERVER_API_URL } from '@app/app.constants';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./state-storage.service\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"./websocket-auth.service\";\nexport let AccountService = /*#__PURE__*/(() => {\n  class AccountService {\n    constructor(http, stateStorageService, router, websocketService) {\n      this.http = http;\n      this.stateStorageService = stateStorageService;\n      this.router = router;\n      this.websocketService = websocketService;\n      this.userIdentity = null;\n      this.authenticationState = new ReplaySubject(1);\n    }\n    save(account) {\n      return this.http.post(SERVER_API_URL + '/api/account', account);\n    }\n    update(account) {\n      return this.http.put(SERVER_API_URL + '/api/account', account);\n    }\n    authenticate(identity) {\n      this.userIdentity = identity;\n      this.authenticationState.next(this.userIdentity);\n      if (identity) {\n        this.websocketService.connect();\n      } else {\n        this.websocketService.disconnect();\n      }\n    }\n    hasAnyAuthority(authorities) {\n      if (!this.userIdentity?.authorities) {\n        return false;\n      }\n      if (!Array.isArray(authorities)) {\n        authorities = [authorities];\n      }\n      return this.userIdentity.authorities.some(authority => authorities.includes(authority));\n    }\n    identity(force) {\n      if (!this.accountCache$ || force || !this.isAuthenticated()) {\n        this.accountCache$ = this.fetch().pipe(catchError(() => {\n          return of(null);\n        }), tap(account => {\n          this.authenticate(account);\n          if (account) {\n            this.navigateToStoredUrl();\n          }\n        }), shareReplay());\n      }\n      return this.accountCache$;\n    }\n    isAuthenticated() {\n      return this.userIdentity !== null;\n    }\n    getAuthenticationState() {\n      return this.authenticationState.asObservable();\n    }\n    getImageUrl() {\n      return this.userIdentity ? this.userIdentity.imageUrl : '';\n    }\n    fetch() {\n      return this.http.get(SERVER_API_URL + '/api/account');\n    }\n    navigateToStoredUrl() {\n      // previousState can be set in the authExpiredInterceptor and in the userRouteAccessService\n      // if login is successful, go to stored previousState and clear previousState\n      const previousUrl = this.stateStorageService.getUrl();\n      if (previousUrl) {\n        this.stateStorageService.clearUrl();\n        this.router.navigateByUrl(previousUrl);\n      }\n    }\n    static {\n      this.ɵfac = function AccountService_Factory(t) {\n        return new (t || AccountService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.StateStorageService), i0.ɵɵinject(i3.Router), i0.ɵɵinject(i4.WebsocketAuthService));\n      };\n    }\n    static {\n      this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n        token: AccountService,\n        factory: AccountService.ɵfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return AccountService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}