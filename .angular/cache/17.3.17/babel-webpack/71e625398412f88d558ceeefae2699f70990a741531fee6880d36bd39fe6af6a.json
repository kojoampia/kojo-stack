{"ast":null,"code":"import { isDevMode } from '@angular/core';\nimport { map } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"./account.service\";\nimport * as i3 from \"./state-storage.service\";\nexport class UserRouteAccessService {\n  constructor(router, accountService, stateStorageService) {\n    this.router = router;\n    this.accountService = accountService;\n    this.stateStorageService = stateStorageService;\n  }\n  canActivate(route, state) {\n    const authorities = route.data['authorities'];\n    // We need to call the checkLogin / and so the accountService.identity() function, to ensure,\n    // that the client has a principal too, if they already logged in by the server.\n    // This could happen on a page refresh.\n    return this.checkLogin(authorities, state.url);\n  }\n  checkLogin(authorities, url) {\n    return this.accountService.identity().pipe(map(account => {\n      if (!authorities || authorities.length === 0) {\n        return true;\n      }\n      if (account) {\n        const hasAnyAuthority = this.accountService.hasAnyAuthority(authorities);\n        if (hasAnyAuthority) {\n          return true;\n        }\n        if (isDevMode()) {\n          console.error('User has not any of required authorities: ', authorities);\n        }\n        this.router.navigate(['accessdenied']);\n        return false;\n      }\n      this.stateStorageService.storeUrl(url);\n      this.router.navigate(['/login']);\n      return false;\n    }));\n  }\n  static {\n    this.ɵfac = function UserRouteAccessService_Factory(t) {\n      return new (t || UserRouteAccessService)(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.AccountService), i0.ɵɵinject(i3.StateStorageService));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: UserRouteAccessService,\n      factory: UserRouteAccessService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"names":["isDevMode","map","UserRouteAccessService","constructor","router","accountService","stateStorageService","canActivate","route","state","authorities","data","checkLogin","url","identity","pipe","account","length","hasAnyAuthority","console","error","navigate","storeUrl","i0","ɵɵinject","i1","Router","i2","AccountService","i3","StateStorageService","factory","ɵfac","providedIn"],"sources":["/home/kojo/work/JojoAddisonDev/kojo-stack/src/app/core/auth/user-route-access-service.ts"],"sourcesContent":["import { Injectable, isDevMode } from '@angular/core';\nimport { ActivatedRouteSnapshot, CanActivate, Router, RouterStateSnapshot } from '@angular/router';\nimport { Observable } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\nimport { AccountService } from './account.service';\nimport { StateStorageService } from './state-storage.service';\n\n@Injectable({ providedIn: 'root' })\nexport class UserRouteAccessService implements CanActivate {\n  constructor(private readonly router: Router, private readonly accountService: AccountService, private readonly stateStorageService: StateStorageService) {}\n\n  canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable<boolean> {\n    const authorities = route.data['authorities'];\n    // We need to call the checkLogin / and so the accountService.identity() function, to ensure,\n    // that the client has a principal too, if they already logged in by the server.\n    // This could happen on a page refresh.\n    return this.checkLogin(authorities, state.url);\n  }\n\n  checkLogin(authorities: string[], url: string): Observable<boolean> {\n    return this.accountService.identity().pipe(\n      map(account => {\n        if (!authorities || authorities.length === 0) {\n          return true;\n        }\n\n        if (account) {\n          const hasAnyAuthority = this.accountService.hasAnyAuthority(authorities);\n          if (hasAnyAuthority) {\n            return true;\n          }\n          if (isDevMode()) {\n            console.error('User has not any of required authorities: ', authorities);\n          }\n          this.router.navigate(['accessdenied']);\n          return false;\n        }\n\n        this.stateStorageService.storeUrl(url);\n        this.router.navigate(['/login']);\n        return false;\n      })\n    );\n  }\n}\n"],"mappings":"AAAA,SAAqBA,SAAS,QAAQ,eAAe;AAGrD,SAASC,GAAG,QAAQ,gBAAgB;;;;;AAMpC,OAAM,MAAOC,sBAAsB;EACjCC,YAA6BC,MAAc,EAAmBC,cAA8B,EAAmBC,mBAAwC;IAA1H,KAAAF,MAAM,GAANA,MAAM;IAA2B,KAAAC,cAAc,GAAdA,cAAc;IAAmC,KAAAC,mBAAmB,GAAnBA,mBAAmB;EAAwB;EAE1JC,WAAWA,CAACC,KAA6B,EAAEC,KAA0B;IACnE,MAAMC,WAAW,GAAGF,KAAK,CAACG,IAAI,CAAC,aAAa,CAAC;IAC7C;IACA;IACA;IACA,OAAO,IAAI,CAACC,UAAU,CAACF,WAAW,EAAED,KAAK,CAACI,GAAG,CAAC;EAChD;EAEAD,UAAUA,CAACF,WAAqB,EAAEG,GAAW;IAC3C,OAAO,IAAI,CAACR,cAAc,CAACS,QAAQ,EAAE,CAACC,IAAI,CACxCd,GAAG,CAACe,OAAO,IAAG;MACZ,IAAI,CAACN,WAAW,IAAIA,WAAW,CAACO,MAAM,KAAK,CAAC,EAAE;QAC5C,OAAO,IAAI;;MAGb,IAAID,OAAO,EAAE;QACX,MAAME,eAAe,GAAG,IAAI,CAACb,cAAc,CAACa,eAAe,CAACR,WAAW,CAAC;QACxE,IAAIQ,eAAe,EAAE;UACnB,OAAO,IAAI;;QAEb,IAAIlB,SAAS,EAAE,EAAE;UACfmB,OAAO,CAACC,KAAK,CAAC,4CAA4C,EAAEV,WAAW,CAAC;;QAE1E,IAAI,CAACN,MAAM,CAACiB,QAAQ,CAAC,CAAC,cAAc,CAAC,CAAC;QACtC,OAAO,KAAK;;MAGd,IAAI,CAACf,mBAAmB,CAACgB,QAAQ,CAACT,GAAG,CAAC;MACtC,IAAI,CAACT,MAAM,CAACiB,QAAQ,CAAC,CAAC,QAAQ,CAAC,CAAC;MAChC,OAAO,KAAK;IACd,CAAC,CAAC,CACH;EACH;;;uBAnCWnB,sBAAsB,EAAAqB,EAAA,CAAAC,QAAA,CAAAC,EAAA,CAAAC,MAAA,GAAAH,EAAA,CAAAC,QAAA,CAAAG,EAAA,CAAAC,cAAA,GAAAL,EAAA,CAAAC,QAAA,CAAAK,EAAA,CAAAC,mBAAA;IAAA;EAAA;;;aAAtB5B,sBAAsB;MAAA6B,OAAA,EAAtB7B,sBAAsB,CAAA8B,IAAA;MAAAC,UAAA,EADT;IAAM;EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}